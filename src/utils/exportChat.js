// ============================================
// Chat Export Utility
// ============================================
// Exports chat as formatted TXT or JSON
// Restored from original chat.js exportChat
// ============================================

// ==========================================
// EXPORT AS FORMATTED TEXT
// ==========================================
export function exportChatAsText(messages, sessionId, context) {
  if (!messages || messages.length === 0) {
    alert('No messages to export!');
    return;
  }

  const conversationDuration = context.conversationDuration || 0;
  const topicsDiscussed = context.topicsDiscussed || [];

  // Header
  const header = [
    'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—',
    'â•‘           PAGETURNER BOOKS - CHAT TRANSCRIPT               â•‘',
    'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•',
    '',
    `ğŸ“… Exported: ${new Date().toLocaleString()}`,
    `ğŸ”‘ Session ID: ${sessionId}`,
    `ğŸ’¬ Total Messages: ${messages.length}`,
    `â±ï¸ Session Duration: ${conversationDuration} minutes`,
    `ğŸ¯ Topics Discussed: ${topicsDiscussed.join(', ') || 'N/A'}`,
    '',
    'â•'.repeat(65),
    ''
  ].join('\n');

  // Messages
  const chatContent = messages.map((msg) => {
    const role = msg.role === 'user' ? 'ğŸ‘¤ YOU' : 'ğŸ¤– PAGETURNER BOT';
    const time = msg.timestamp || 'N/A';
    const intent = msg.intent ? ` [${msg.intent}]` : '';

    const cleanContent = msg.content
      .replace(/\*\*/g, '')
      .replace(/\*/g, '')
      .replace(/#{1,6}\s/g, '');

    return [
      `â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”`,
      `â”‚ ${role} - ${time}${intent}`,
      `â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤`,
      `â”‚`,
      cleanContent.split('\n').map(line => `â”‚ ${line}`).join('\n'),
      `â”‚`,
      `â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`,
      ''
    ].join('\n');
  }).join('\n');

  // Footer
  const footer = [
    '',
    'â•'.repeat(65),
    '',
    'ğŸ“Š SESSION SUMMARY',
    'â”€'.repeat(30),
    `â€¢ Questions Asked: ${context.questionsAsked || 0}`,
    `â€¢ Favorite Genre: ${context.preferences?.favoriteGenre || 'Not specified'}`,
    `â€¢ Last Book Viewed: ${context.lastBookMentioned || 'N/A'}`,
    `â€¢ Last Order Checked: ${context.lastOrderChecked || 'N/A'}`,
    '',
    'â•'.repeat(65),
    '',
    'Thank you for chatting with PageTurner Books!',
    'ğŸ“š Visit us again soon!',
    '',
    `Generated by PageTurner AI Chat Assistant Â© ${new Date().getFullYear()}`
  ].join('\n');

  const fullExport = header + chatContent + footer;

  downloadFile(
    fullExport,
    `PageTurner-Chat-${sessionId.slice(-8)}-${new Date().toISOString().slice(0, 10)}.txt`,
    'text/plain;charset=utf-8'
  );

  console.log('ğŸ“¥ Chat exported as TXT successfully!');
}

// ==========================================
// EXPORT AS JSON
// ==========================================
export function exportChatAsJSON(messages, sessionId, context) {
  if (!messages || messages.length === 0) {
    alert('No messages to export!');
    return;
  }

  const exportData = {
    sessionId,
    exportedAt: new Date().toISOString(),
    messageCount: messages.length,
    conversationContext: context,
    messages
  };

  downloadFile(
    JSON.stringify(exportData, null, 2),
    `PageTurner-Chat-${sessionId.slice(-8)}.json`,
    'application/json'
  );

  console.log('ğŸ“¥ Chat exported as JSON successfully!');
}

// ==========================================
// DOWNLOAD FILE HELPER
// ==========================================
function downloadFile(content, filename, contentType) {
  const blob = new Blob([content], { type: contentType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ==========================================
// ADMIN DATA EXPORT
// ==========================================
export function exportAdminData(books, orders, faqs, chatLogs, analytics) {
  const exportObj = {
    exportedAt: new Date().toISOString(),
    books,
    orders,
    faqs,
    chatLogs,
    analytics
  };

  downloadFile(
    JSON.stringify(exportObj, null, 2),
    `pageturner-admin-export-${new Date().toISOString().slice(0, 10)}.json`,
    'application/json'
  );

  console.log('ğŸ“¥ Admin data exported');
}